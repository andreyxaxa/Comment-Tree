<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CommentTree - –î—Ä–µ–≤–æ–≤–∏–¥–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            margin-bottom: 30px;
            color: #2c3e50;
        }

        /* Search & Filters */
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .search-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .search-row input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .search-row button {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .search-row button:hover {
            background: #2980b9;
        }

        .filters {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filters label {
            font-size: 14px;
            color: #666;
        }

        .filters select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        /* New Comment Form */
        .new-comment-form {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .new-comment-form h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .new-comment-form textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
        }

        .new-comment-form .form-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .btn-primary {
            background: #27ae60;
            color: white;
        }

        .btn-primary:hover {
            background: #229954;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        /* Comments */
        .comments-list {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .comment {
            border-left: 3px solid #3498db;
            padding: 15px;
            margin-bottom: 15px;
            background: #f9f9f9;
            border-radius: 4px;
            position: relative;
        }

        .comment.depth-0 {
            margin-left: 0;
        }

        .comment.depth-1 {
            margin-left: 30px;
            border-left-color: #9b59b6;
        }

        .comment.depth-2 {
            margin-left: 60px;
            border-left-color: #e74c3c;
        }

        .comment.depth-3 {
            margin-left: 90px;
            border-left-color: #f39c12;
        }

        .comment.depth-4 {
            margin-left: 120px;
            border-left-color: #1abc9c;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .comment-meta {
            font-size: 12px;
            color: #7f8c8d;
        }

        .comment-actions {
            display: flex;
            gap: 10px;
        }

        .comment-actions button {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-reply {
            background: #3498db;
            color: white;
        }

        .btn-reply:hover {
            background: #2980b9;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
        }

        .btn-delete:hover {
            background: #c0392b;
        }

        .comment-content {
            color: #2c3e50;
            word-wrap: break-word;
        }

        /* Reply Form */
        .reply-form {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }

        .reply-form textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 60px;
            margin-bottom: 10px;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .pagination button {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .pagination button:hover:not(:disabled) {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .page-info {
            font-size: 14px;
            color: #666;
        }

        /* Loading & Empty States */
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #95a5a6;
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        /* Utility */
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üí¨ CommentTree</h1>

        <!-- Search & Filters -->
        <div class="controls">
            <div class="search-row">
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º..."
                    onkeypress="if(event.key==='Enter') searchComments()"
                >
                <button onclick="searchComments()">üîç –ù–∞–π—Ç–∏</button>
                <button onclick="clearSearch()">‚úï –û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
            
            <div class="filters">
                <label>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</label>
                <select id="sortBy">
                    <option value="created_at">–ü–æ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–Ω–∏—è</option>
                    <option value="id">–ü–æ ID</option>
                </select>

                <select id="order">
                    <option value="DESC">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
                    <option value="ASC">–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ</option>
                </select>

                <label>–ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ:</label>
                <select id="limit">
                    <option value="10">10</option>
                    <option value="20" selected>20</option>
                    <option value="50">50</option>
                </select>
            </div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="error hidden"></div>

        <!-- New Comment Form -->
        <div class="new-comment-form">
            <h3>‚úçÔ∏è –ù–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h3>
            <textarea 
                id="newCommentContent" 
                placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."
            ></textarea>
            <div class="form-actions">
                <button class="btn btn-primary" id="sendRootComment"> –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>

        <!-- Comments List -->
        <div class="comments-list">
            <div id="commentsContainer">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤...</div>
            </div>
        </div>

        <!-- Pagination -->
        <div class="pagination" id="pagination" style="display: none;">
            <button id="prevBtn" onclick="prevPage()">‚Üê –ù–∞–∑–∞–¥</button>
            <span class="page-info" id="pageInfo">–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1 –∏–∑ 1</span>
            <button id="nextBtn" onclick="nextPage()">–í–ø–µ—Ä—ë–¥ ‚Üí</button>
        </div>
    </div>

    <script>
        const API_BASE = '/v1/comments';
        let currentPage = 1;
        let totalPages = 1;
        let currentSearch = '';

        // Load comments on page load
        document.addEventListener('DOMContentLoaded', () => {
            updateOrderOptions();
            loadComments();

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            document.getElementById('sortBy').addEventListener('change', () => {
                updateOrderOptions();
                loadComments();
            });

            document.getElementById('order').addEventListener('change', () => {
                loadComments();
            });

            document.getElementById('limit').addEventListener('change', () => {
                currentPage = 1;
                loadComments();
            });

            document.getElementById('sendRootComment').addEventListener('click', createComment);
        });

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –æ–ø—Ü–∏–π order –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç sortBy
        function updateOrderOptions() {
            const sortBy = document.getElementById('sortBy').value;
            const orderSelect = document.getElementById('order');
            const currentValue = orderSelect.value;

            if (sortBy === 'created_at') {
                orderSelect.innerHTML = `
                    <option value="DESC">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
                    <option value="ASC">–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ</option>
                `;
            } else if (sortBy === 'id') {
                orderSelect.innerHTML = `
                    <option value="DESC">–ü–æ —É–±—ã–≤–∞–Ω–∏—é ID</option>
                    <option value="ASC">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é ID</option>
                `;
            }

            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            orderSelect.value = currentValue;
        }

        // Load comments from API
        async function loadComments(page = 1) {
            try {
                hideError();
                const limit = document.getElementById('limit').value;
                const sortBy = document.getElementById('sortBy').value;
                const order = document.getElementById('order').value;
                const offset = (page - 1) * parseInt(limit);

                let url = `${API_BASE}?limit=${limit}&offset=${offset}&sort_by=${sortBy}&order=${order}`;
                
                if (currentSearch) {
                    url += `&search=${encodeURIComponent(currentSearch)}`;
                }

                console.log('Requesting:', url); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏

                const response = await fetch(url);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                currentPage = data.page || 1;
                totalPages = data.pages || 1;

                renderComments(data.comments || []);
                updatePagination(data);

            } catch (error) {
                console.error('Error loading comments:', error);
                showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤: ' + error.message);
            }
        }

        // Render comments tree
        function renderComments(comments) {
            const container = document.getElementById('commentsContainer');
            
            if (!comments || comments.length === 0) {
                container.innerHTML = '<div class="empty-state">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</div>';
                return;
            }

            container.innerHTML = comments.map(comment => renderComment(comment)).join('');
        }

        // Render single comment with children
        function renderComment(comment) {
            const date = new Date(comment.created_at).toLocaleString('ru-RU');
            const depth = comment.depth || 0;
            
            let html = `
                <div class="comment depth-${Math.min(depth, 4)}" data-id="${comment.id}">
                    <div class="comment-header">
                        <div class="comment-meta">
                            #${comment.id} ‚Ä¢ ${date} ‚Ä¢ –£—Ä–æ–≤–µ–Ω—å ${depth}
                        </div>
                        <div class="comment-actions">
                            <button class="btn-reply" onclick="showReplyForm(${comment.id})">
                                üí¨ –û—Ç–≤–µ—Ç–∏—Ç—å
                            </button>
                            <button class="btn-delete" onclick="deleteComment(${comment.id})">
                                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </div>
                    </div>
                    <div class="comment-content">${escapeHtml(comment.content)}</div>
                    <div id="reply-form-${comment.id}" class="reply-form hidden">
                        <textarea 
                            id="reply-content-${comment.id}" 
                            placeholder="–í–∞—à –æ—Ç–≤–µ—Ç..."
                        ></textarea>
                        <div class="form-actions">
                            <button class="btn btn-primary" onclick="submitReply(${comment.id})">
                                –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                            </button>
                            <button class="btn btn-secondary" onclick="hideReplyForm(${comment.id})">
                                –û—Ç–º–µ–Ω–∞
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Render children recursively
            if (comment.children && comment.children.length > 0) {
                html += comment.children.map(child => renderComment(child)).join('');
            }

            return html;
        }

        // Create new root comment
        async function createComment() {
            const content = document.getElementById('newCommentContent').value.trim();
            
            if (!content) {
                showError('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
                return;
            }

            try {
                hideError();
                console.log('Creating comment:', { parent_id: null, content }); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏

                const response = await fetch(API_BASE, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        content: content
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'Failed to create comment');
                }

                const result = await response.json();
                console.log('Comment created:', result); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏

                document.getElementById('newCommentContent').value = '';
                
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
                currentPage = 1;
                await loadComments(1);

            } catch (error) {
                console.error('Error creating comment:', error);
                showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è: ' + error.message);
            }
        }

        // Show reply form
        function showReplyForm(commentId) {
            // Hide all other reply forms
            document.querySelectorAll('.reply-form').forEach(form => {
                form.classList.add('hidden');
            });

            // Show this reply form
            const form = document.getElementById(`reply-form-${commentId}`);
            form.classList.remove('hidden');
            document.getElementById(`reply-content-${commentId}`).focus();
        }

        // Hide reply form
        function hideReplyForm(commentId) {
            const form = document.getElementById(`reply-form-${commentId}`);
            form.classList.add('hidden');
            document.getElementById(`reply-content-${commentId}`).value = '';
        }

        // Submit reply
        async function submitReply(parentId) {
            const content = document.getElementById(`reply-content-${parentId}`).value.trim();
            
            if (!content) {
                showError('–û—Ç–≤–µ—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
                return;
            }

            try {
                hideError();
                console.log('Creating reply:', { parent_id: parentId, content }); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏

                const response = await fetch(API_BASE, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        parent_id: parentId,
                        content: content
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'Failed to create reply');
                }

                const result = await response.json();
                console.log('Reply created:', result); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏

                hideReplyForm(parentId);
                await loadComments(currentPage);

            } catch (error) {
                console.error('Error creating reply:', error);
                showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞: ' + error.message);
            }
        }

        // Delete comment
        async function deleteComment(commentId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏ –≤—Å–µ –æ—Ç–≤–µ—Ç—ã –∫ –Ω–µ–º—É?')) {
                return;
            }

            try {
                hideError();
                console.log('Deleting comment:', commentId); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏

                const response = await fetch(`${API_BASE}/${commentId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'Failed to delete comment');
                }

                console.log('Comment deleted:', commentId); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
                await loadComments(currentPage);

            } catch (error) {
                console.error('Error deleting comment:', error);
                showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è: ' + error.message);
            }
        }

        // Search comments
        function searchComments() {
            const searchInput = document.getElementById('searchInput');
            currentSearch = searchInput.value.trim();
            currentPage = 1;
            loadComments(1);
        }

        // Clear search
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            currentSearch = '';
            currentPage = 1;
            loadComments(1);
        }

        // Pagination
        function updatePagination(data) {
            const pagination = document.getElementById('pagination');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const pageInfo = document.getElementById('pageInfo');

            if (data.pages > 1) {
                pagination.style.display = 'flex';
                prevBtn.disabled = data.page === 1;
                nextBtn.disabled = data.page >= data.pages;
                pageInfo.textContent = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${data.page} –∏–∑ ${data.pages} (–≤—Å–µ–≥–æ: ${data.total})`;
            } else {
                pagination.style.display = 'none';
            }
        }

        function prevPage() {
            if (currentPage > 1) {
                loadComments(currentPage - 1);
            }
        }

        function nextPage() {
            if (currentPage < totalPages) {
                loadComments(currentPage + 1);
            }
        }

        // Error handling
        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
            
            // Scroll to error
            errorEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function hideError() {
            const errorEl = document.getElementById('errorMessage');
            errorEl.classList.add('hidden');
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>